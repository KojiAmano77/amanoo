<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動記録ダッシュボード</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            gap: 10px;
        }
        .form-row > * {
            flex: 1;
        }
        input, select, textarea, button {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:active {
            background-color: #3d8b40;
        }
        .logout-btn {
            background-color: #f44336;
            padding: 8px 16px;
            font-size: 14px;
        }
        .logout-btn:hover {
            background-color: #da190b;
        }
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            background: #e9ecef; /* 明るいグレー */
            color: #333;          /* 黒に近い文字色 */
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 13px;
            text-align: center;
            transition: background 0.3s, color 0.3s;
        }

        .tab:hover {
            background: #dfe3e6; /* ホバー時に少し濃いグレー */
        }

        .tab.active {
            background: #4CAF50; /* 緑色 */
            color: white;        /* 白文字でコントラスト */
            border-bottom-color: #388E3C;
            font-weight: bold;
        }

        .tab-content {
            background: white;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        
        /* 地図用スタイル */
        #map {
            height: 300px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .map-toggle-btn {
            background-color: #2196F3;
            margin-top: 5px;
            padding: 8px;
            font-size: 14px;
        }
        
        .map-toggle-btn:hover {
            background-color: #1976D2;
        }

        /* 活動リスト（モバイル対応） */
        .activities-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .activities-table th, .activities-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .activities-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .edit-btn, .delete-btn, .map-btn {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }
        .edit-btn {
            background-color: #008CBA;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .map-btn {
            background-color: #ff9800;
        }

        /* 場所表示 */
        .location-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .location-loading {
            color: #666;
            font-style: italic;
        }
        .location-error {
            color: #888;
            font-size: 12px;
        }

        /* モバイル専用リスト */
        .mobile-activity-list {
            display: none;
        }
        .activity-card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .activity-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .activity-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        /* タブレット以上 */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .header {
                flex-direction: row;
                justify-content: space-between;
                padding: 20px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .tab-content {
                padding: 20px;
            }
            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .form-grid.full {
                grid-template-columns: 1fr;
            }
            .tab {
                padding: 15px;
                font-size: 14px;
            }
            #map {
                height: 400px;
            }
        }

        /* デスクトップ */
        @media (min-width: 1024px) {
            .activities-table {
                font-size: 16px;
            }
            #map {
                height: 500px;
            }
        }

        /* モバイル専用 - テーブルを縦並びに */
        @media (max-width: 767px) {
            .activities-table {
                display: none;
            }
            .mobile-activity-list {
                display: block;
            }
        }
        
        /* デスクトップではモバイルリストを非表示 */
        @media (min-width: 768px) {
            .mobile-activity-list {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>地域活動記録</h1>
            <button class="logout-btn" onclick="logout()">ログアウト</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('map-view')">地図</button>
            <button class="tab" onclick="switchTab('my-activities')">自分の記録</button>
            <button class="tab" onclick="switchTab('team-activities')">チーム記録</button>
            <button class="tab" onclick="switchTab('add-activity')">入力フォーム</button>
        </div>

        <div class="tab-content">
            <div id="message-area"></div>

            <!-- 地図タブ -->
            <div id="map-view">
                <h2>地図をタップして記録作成</h2>
                <div id="map"></div>
                <p style="color: #666; font-size: 14px;">地図上をタップすると、その場所での活動記録を作成できます。</p>
            </div>

            <!-- 入力フォームタブ -->
            <div id="add-activity" class="hidden">
                <h2>活動記録を入力</h2>
                <form id="activity-form">
                    <div class="form-grid">
                        <select id="activity-type" required>
                            <option value="">活動種別を選択</option>
                            <option value="ポスター掲示">ポスター掲示</option>
                            <option value="チラシ投函">チラシ投函</option>
                            <option value="辻立ち">辻立ち</option>
                            <option value="その他">その他</option>
                        </select>
                        <input type="date" id="activity-date" required>
                    </div>
                    <div class="form-grid full">
                        <input type="text" id="location" placeholder="実施場所" required>
                        <button type="button" class="map-toggle-btn" onclick="toggleLocationMap()">地図で場所を選択</button>
                        <div id="location-map" class="hidden" style="height: 300px; margin-top: 10px; border-radius: 6px;"></div>
                    </div>
                    <div class="form-grid full">
                        <textarea id="memo" placeholder="メモ（任意）"></textarea>
                    </div>
                    <button type="submit">記録する</button>
                </form>
            </div>

            <!-- 自分の活動記録タブ -->
            <div id="my-activities" class="hidden">
                <h2>自分の活動記録</h2>
                
                <!-- デスクトップ用テーブル -->
                <table class="activities-table">
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>活動種別</th>
                            <th>場所</th>
                            <th>メモ</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="my-activities-tbody">
                    </tbody>
                </table>

                <!-- モバイル用リスト -->
                <div class="mobile-activity-list" id="my-activities-mobile">
                </div>
            </div>

            <!-- チーム全体の記録タブ -->
            <div id="team-activities" class="hidden">
                <h2>チーム全体の活動記録</h2>
                
                <!-- デスクトップ用テーブル -->
                <table class="activities-table">
                    <thead>
                        <tr>
                            <th>担当者</th>
                            <th>日付</th>
                            <th>活動種別</th>
                            <th>場所</th>
                            <th>メモ</th>
                        </tr>
                    </thead>
                    <tbody id="team-activities-tbody">
                    </tbody>
                </table>

                <!-- モバイル用リスト -->
                <div class="mobile-activity-list" id="team-activities-mobile">
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentToken = localStorage.getItem('access_token');
        let editingActivityId = null;
        let map, locationMap;
        let selectedLat = null, selectedLng = null;
        let activityMarkers = [];

        if (!currentToken) {
            window.location.href = '/';
        }

        // 今日の日付をデフォルトに設定
        document.getElementById('activity-date').valueAsDate = new Date();

        // 地図初期化（東岡崎駅周辺）
        function initMaps() {
            // メイン地図
            map = L.map('map').setView([34.9576, 137.1656], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 地図クリックイベント
            map.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // フォームタブに切り替えて値を設定
                switchTab('add-activity');
                document.querySelector('[onclick="switchTab(\'add-activity\')"]').click();
                
                // 住所を取得中の表示
                document.getElementById('location').value = '住所取得中...';
                selectedLat = lat;
                selectedLng = lng;
                
                // 非同期で住所を取得
                try {
                    const locationName = await getLocationName(lat, lng);
                    currentLocationName = locationName;
                    document.getElementById('location').value = locationName + '周辺';
                    showMessage('地図上の位置が選択されました。活動記録を入力してください。', 'success');
                } catch (error) {
                    const fallback = `緯度: ${lat.toFixed(5)}, 経度: ${lng.toFixed(5)}`;
                    document.getElementById('location').value = fallback + '周辺';
                    currentLocationName = fallback;
                    showMessage('地図上の位置が選択されました。活動記録を入力してください。', 'success');
                }
            });

            // 場所選択用地図
            locationMap = L.map('location-map').setView([34.9576, 137.1656], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(locationMap);

            let locationMarker = null;
            locationMap.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (locationMarker) {
                    locationMap.removeLayer(locationMarker);
                }
                
                locationMarker = L.marker([lat, lng]).addTo(locationMap);
                
                // 住所取得中
                document.getElementById('location').value = '住所取得中...';
                selectedLat = lat;
                selectedLng = lng;
                
                // 非同期で住所を取得
                try {
                    const locationName = await getLocationName(lat, lng);
                    currentLocationName = locationName;
                    document.getElementById('location').value = locationName + '周辺';
                } catch (error) {
                    const fallback = `緯度: ${lat.toFixed(5)}, 経度: ${lng.toFixed(5)}`;
                    document.getElementById('location').value = fallback + '周辺';
                    currentLocationName = fallback;
                }
            });
        }

        // 場所選択地図の表示切替
        function toggleLocationMap() {
            const mapDiv = document.getElementById('location-map');
            if (mapDiv.classList.contains('hidden')) {
                mapDiv.classList.remove('hidden');
                setTimeout(() => {
                    locationMap.invalidateSize();
                }, 100);
            } else {
                mapDiv.classList.add('hidden');
            }
        }

        // タブ切り替え
        function switchTab(tabName) {
            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-content > div').forEach(div => {
                if (div.id !== 'message-area') {
                    div.classList.add('hidden');
                }
            });
            
            // すべてのタブボタンのアクティブクラスを削除
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 選択されたタブを表示
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');

            // 地図サイズ調整
            if (tabName === 'map-view') {
                setTimeout(() => {
                    map.invalidateSize();
                    loadActivitiesOnMap();
                }, 100);
            } else if (tabName === 'my-activities') {
                loadMyActivities();
            } else if (tabName === 'team-activities') {
                loadTeamActivities();
            }
        }

        // 地図上に活動記録を表示
        async function loadActivitiesOnMap() {
            // 既存のマーカーを削除
            activityMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            activityMarkers = [];

            try {
                const response = await fetch('/activities/all', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    
                    activities.forEach(activity => {
                        if (activity.latitude && activity.longitude) {
                            const marker = L.marker([activity.latitude, activity.longitude])
                                .addTo(map)
                                .bindPopup(`
                                    <b>${activity.activity_type}</b><br>
                                    担当: ${activity.username}<br>
                                    日付: ${new Date(activity.date).toLocaleDateString('ja-JP')}<br>
                                    場所: ${activity.location}<br>
                                    ${activity.memo ? `メモ: ${activity.memo}` : ''}
                                `);
                            activityMarkers.push(marker);
                        }
                    });
                }
            } catch (error) {
                console.error('地図データの読み込みエラー:', error);
            }
        }

        // 活動記録追加フォーム
        document.getElementById('activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('activity_type', document.getElementById('activity-type').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('date', document.getElementById('activity-date').value);
            formData.append('memo', document.getElementById('memo').value);
            
            if (selectedLat && selectedLng) {
                formData.append('latitude', selectedLat);
                formData.append('longitude', selectedLng);
            }
            
            // 取得済みの場所名があれば送信
            if (currentLocationName) {
                formData.append('location_name', currentLocationName);
            }
            
            try {
                const url = editingActivityId ? `/activities/${editingActivityId}` : '/activities';
                const method = editingActivityId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showMessage(editingActivityId ? '記録を更新しました' : '記録を追加しました', 'success');
                    document.getElementById('activity-form').reset();
                    document.getElementById('activity-date').valueAsDate = new Date();
                    document.getElementById('location-map').classList.add('hidden');
                    editingActivityId = null;
                    selectedLat = selectedLng = null;
                    currentLocationName = null;
                    loadMyActivities();
                    loadActivitiesOnMap();
                } else {
                    const result = await response.json();
                    showMessage(result.detail || 'エラーが発生しました', 'error');
                }
            } catch (error) {
                showMessage('ネットワークエラー', 'error');
            }
        });

        // 自分の活動記録を読み込み
        async function loadMyActivities() {
            try {
                const response = await fetch('/activities', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    displayMyActivities(activities);
                } else {
                    showMessage('データの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                showMessage('ネットワークエラー', 'error');
            }
        }

        // チーム全体の活動記録を読み込み
        async function loadTeamActivities() {
            try {
                const response = await fetch('/activities/all', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const activities = await response.json();
                    displayTeamActivities(activities);
                } else {
                    showMessage('データの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                showMessage('ネットワークエラー', 'error');
            }
        }

        // 自分の活動記録表示
        function displayMyActivities(activities) {
            const tbody = document.getElementById('my-activities-tbody');
            const mobileList = document.getElementById('my-activities-mobile');
            
            tbody.innerHTML = '';
            mobileList.innerHTML = '';
            
            activities.forEach(activity => {
                const date = new Date(activity.date).toLocaleDateString('ja-JP');
                
                // デスクトップ用テーブル
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${activity.activity_type}</td>
                    <td>${createLocationDisplay(activity.latitude, activity.longitude, activity.location, activity.location_name)}</td>
                    <td>${activity.memo || ''}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editActivity(${activity.id}, '${activity.activity_type}', '${activity.location}', '${activity.date}', '${activity.memo || ''}', ${activity.latitude || 'null'}, ${activity.longitude || 'null'}, '${activity.location_name || ''}')">編集</button>
                        <button class="delete-btn" onclick="deleteActivity(${activity.id})">削除</button>
                        ${activity.latitude && activity.longitude ? `<button class="map-btn" onclick="showOnMap(${activity.latitude}, ${activity.longitude})">地図</button>` : ''}
                    </td>
                `;

                // モバイル用カード
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.innerHTML = `
                    <div class="activity-header">${activity.activity_type} - ${date}</div>
                    <div class="activity-details">場所: ${createLocationDisplay(activity.latitude, activity.longitude, activity.location, activity.location_name)}</div>
                    ${activity.memo ? `<div class="activity-details">メモ: ${activity.memo}</div>` : ''}
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editActivity(${activity.id}, '${activity.activity_type}', '${activity.location}', '${activity.date}', '${activity.memo || ''}', ${activity.latitude || 'null'}, ${activity.longitude || 'null'}, '${activity.location_name || ''}')">編集</button>
                        <button class="delete-btn" onclick="deleteActivity(${activity.id})">削除</button>
                        ${activity.latitude && activity.longitude ? `<button class="map-btn" onclick="showOnMap(${activity.latitude}, ${activity.longitude})">地図</button>` : ''}
                    </div>
                `;
                mobileList.appendChild(card);
            });
        }

        // チーム全体の活動記録表示
        function displayTeamActivities(activities) {
            const tbody = document.getElementById('team-activities-tbody');
            const mobileList = document.getElementById('team-activities-mobile');
            
            tbody.innerHTML = '';
            mobileList.innerHTML = '';
            
            activities.forEach(activity => {
                const date = new Date(activity.date).toLocaleDateString('ja-JP');
                
                // デスクトップ用テーブル
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${activity.username}</td>
                    <td>${date}</td>
                    <td>${activity.activity_type}</td>
                    <td>${createLocationDisplay(activity.latitude, activity.longitude, activity.location, activity.location_name)}</td>
                    <td>${activity.memo || ''}</td>
                `;

                // モバイル用カード
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.innerHTML = `
                    <div class="activity-header">${activity.activity_type} - ${activity.username}</div>
                    <div class="activity-details">日付: ${date}</div>
                    <div class="activity-details">場所: ${createLocationDisplay(activity.latitude, activity.longitude, activity.location, activity.location_name)}</div>
                    ${activity.memo ? `<div class="activity-details">メモ: ${activity.memo}</div>` : ''}
                `;
                mobileList.appendChild(card);
            });
        }

        // 活動記録編集
        function editActivity(id, activityType, location, date, memo, latitude, longitude, locationName) {
            editingActivityId = id;
            document.getElementById('activity-type').value = activityType;
            document.getElementById('location').value = location;
            document.getElementById('activity-date').value = date.split('T')[0];
            document.getElementById('memo').value = memo;
            
            selectedLat = latitude;
            selectedLng = longitude;
            
            // 保存済みの場所名があれば設定（「周辺」を除去）
            if (locationName) {
                currentLocationName = locationName.replace(/周辺$/, '');
            } else {
                currentLocationName = null;
            }
            
            switchTab('add-activity');
            document.querySelector('[onclick="switchTab(\'add-activity\')"]').click();
        }

        // 活動記録削除
        async function deleteActivity(id) {
            if (!confirm('この記録を削除しますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/activities/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    showMessage('記録を削除しました', 'success');
                    loadMyActivities();
                    loadActivitiesOnMap();
                } else {
                    showMessage('削除に失敗しました', 'error');
                }
            } catch (error) {
                showMessage('ネットワークエラー', 'error');
            }
        }

        // 地図で場所を表示
        function showOnMap(lat, lng) {
            switchTab('map-view');
            document.querySelector('[onclick="switchTab(\'map-view\')"]').click();
            
            setTimeout(() => {
                map.setView([lat, lng], 17);
            }, 100);
        }

        // 逆ジオコーディングキャッシュ
        const geocodeCache = new Map();

        // 座標から住所/ランドマーク名を取得
        async function getLocationName(lat, lng, fallbackText) {
            if (!lat || !lng) {
                return fallbackText || '位置情報なし';
            }

            // キャッシュをチェック
            const cacheKey = `${lat.toFixed(4)},${lng.toFixed(4)}`;
            if (geocodeCache.has(cacheKey)) {
                return geocodeCache.get(cacheKey);
            }

            try {
                // OpenStreetMapのNominatim APIを使用（無料）
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ja`, {
                    headers: {
                        'User-Agent': 'TeamActivityApp/1.0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let locationName = '';
                    
                    if (data.display_name) {
                        // 日本語の住所を優先的に構築
                        const addr = data.address || {};
                        
                        // 建物名やランドマークがあれば優先
                        if (addr.amenity) {
                            locationName = addr.amenity;
                        } else if (addr.building) {
                            locationName = addr.building;
                        } else if (addr.shop) {
                            locationName = addr.shop;
                        } else if (addr.tourism) {
                            locationName = addr.tourism;
                        } else {
                            // 住所を構築
                            const parts = [];
                            if (addr.prefecture || addr.state) parts.push(addr.prefecture || addr.state);
                            if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                            if (addr.suburb || addr.district) parts.push(addr.suburb || addr.district);
                            if (addr.quarter || addr.neighbourhood) parts.push(addr.quarter || addr.neighbourhood);
                            if (addr.road || addr.street) parts.push(addr.road || addr.street);
                            if (addr.house_number) parts.push(addr.house_number);
                            
                            locationName = parts.join(' ') || data.display_name.split(',')[0];
                        }
                        
                        // 長すぎる場合は短縮
                        if (locationName.length > 30) {
                            locationName = locationName.substring(0, 30) + '...';
                        }
                    }
                    
                    const result = locationName || fallbackText || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    geocodeCache.set(cacheKey, result);
                    return result;
                }
            } catch (error) {
                console.log('Geocoding error:', error);
            }
            
            // フォールバック：元のテキストまたは座標
            const result = fallbackText || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            geocodeCache.set(cacheKey, result);
            return result;
        }

        // 場所表示を生成（データベースの場所名を優先使用）
        function createLocationDisplay(lat, lng, originalText, savedLocationName) {
            // 保存済みの場所名がある場合はそれを使用
            if (savedLocationName) {
                const locationText = savedLocationName.endsWith('周辺') ? savedLocationName : savedLocationName + '周辺';
                if (lat && lng) {
                    return `<span class="location-text" style="cursor: pointer;" onclick="showOnMap(${lat}, ${lng})" title="クリックで地図表示 (${lat.toFixed(4)}, ${lng.toFixed(4)})">${locationText}</span>`;
                } else {
                    return `<span class="location-text">${locationText}</span>`;
                }
            }

            // 座標がない場合
            if (!lat || !lng) {
                return `<span class="location-text">${originalText || '位置情報なし'}</span>`;
            }

            // 新規の場合：非同期で住所を取得
            const uniqueId = `location_${Math.random().toString(36).substr(2, 9)}`;
            const initialDisplay = `<span id="${uniqueId}" class="location-loading">住所取得中...</span>`;
            
            setTimeout(async () => {
                const element = document.getElementById(uniqueId);
                if (element) {
                    try {
                        const locationName = await getLocationName(lat, lng, originalText);
                        const displayName = locationName + '周辺';
                        element.textContent = displayName;
                        element.className = 'location-text';
                        element.style.cursor = 'pointer';
                        element.onclick = () => showOnMap(lat, lng);
                        element.title = `クリックで地図表示 (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                        
                        // 取得した場所名をサーバーに送信（今後の記録で使用するため）
                        currentLocationName = locationName;
                    } catch (error) {
                        const fallbackName = (originalText || `座標 ${lat.toFixed(4)}, ${lng.toFixed(4)}`) + '周辺';
                        element.textContent = fallbackName;
                        element.className = 'location-text';
                        element.style.cursor = 'pointer';
                        element.onclick = () => showOnMap(lat, lng);
                    }
                }
            }, 100);
            
            return initialDisplay;
        }

        // 現在取得中の場所名を保存する変数
        let currentLocationName = null;

        // ログアウト
        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/';
        }

        // メッセージ表示
        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initMaps();
            loadMyActivities();
        });
    </script>
</body>
</html>