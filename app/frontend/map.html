<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配達エリア記録アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body, html {
      margin: 0;
      height: 100%;
    }
    #map {
      height: 80%;
    }
    #controls {
      padding: 1em;
    }
    input, button {
      margin: 0.5em 0;
      font-size: 1rem;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>
    担当者:
    <input type="text" id="person" placeholder="担当者名">
  </label><br>
  <label>
    日付:
    <input type="date" id="date">
  </label><br>
  <button id="start">描画開始</button>
  <button id="finish">描画終了</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // 地図初期化（東岡崎駅）
  const map = L.map('map').setView([34.9576, 137.1656], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // 日付デフォルト：今日
  document.getElementById('date').valueAsDate = new Date();

  let drawing = false;
  let currentLatLngs = [];
  let currentPolyline = null;

  const drawnPolygons = [];

  // 描画開始
  document.getElementById('start').addEventListener('click', () => {
    drawing = true;
    currentLatLngs = [];
    if (currentPolyline) {
      map.removeLayer(currentPolyline);
    }
  });

  // 地図上のクリックで点を追加
  function addPoint(e) {
    if (!drawing) return;
    currentLatLngs.push(e.latlng);

    if (currentPolyline) {
      currentPolyline.setLatLngs(currentLatLngs);
    } else {
      currentPolyline = L.polyline(currentLatLngs, { color: 'blue' }).addTo(map);
    }
  }

  map.on('click', addPoint);

  // 描画終了
  document.getElementById('finish').addEventListener('click', () => {
    if (currentLatLngs.length < 3) {
      alert("3点以上で囲ってください");
      return;
    }

    drawing = false;

    const polygon = L.polygon(currentLatLngs, {
      color: 'green',
      fillColor: 'green',
      fillOpacity: 0.4
    }).addTo(map);

    // 担当者・日付情報を保存（例：popupに表示）
    const person = document.getElementById('person').value || '未設定';
    const date = document.getElementById('date').value;
    polygon.bindPopup(`担当: ${person}<br>日付: ${date}`).openPopup();

    drawnPolygons.push({ person, date, latlngs: currentLatLngs });

    // リセット
    if (currentPolyline) {
      map.removeLayer(currentPolyline);
      currentPolyline = null;
    }
    currentLatLngs = [];
  });
</script>
</body>
</html>
